-- Запросы к лабработe 3.3

-- Запрос 1
-- Рефлексивное соединение. Представление отношений родитель-потомок.
-- Требуется представить имя каждого сотрудника таблицы EMP, а также имя его руководителя.
-- Команда AS команда используется для переименования столбца или таблицы с псевдонимами.
-- Псевдоним существует только на время выполнения запроса.
SELECT (A.EMPNAME, B.EMPNAME) AS EMP_MANAGER 
FROM EMP A 
JOIN EMP B 
ON A.MANAGER_ID = B.EMPNO
ORDER BY A.MANAGER_ID;

-- Запрос 2
-- Иерархический запрос.
-- Требуется представить имя каждого сотрудника таблицы EMP (даже сотрудника, которому не назначен руководитель) и имя его руководителя.
-- PRIOR возвращает индекс предыдущего существующего элемента коллекции, если таковой существует. В противном случае PRIOR возвращает NULL.
-- CONNECT BY – задает отношение между родительскими и дочерними строками в иерархии. Отношение задается «P-условием», это может быть любое 
-- сравнение, но какая-то его часть должна содержать ключевое слово PRIOR, относящееся к родительской строке.
SELECT (EMPNAME, PRIOR EMPNAME) AS EMP_MANAGER
FROM EMP
START WITH MANAGER_ID IS NULL
CONNECT BY PRIOR EMPNO = MANAGER_ID; 

-- Запрос 3
-- Представление отношений потомок-родитель-прародитель.
-- Требуется показать иерархию от CLARK до JOHN KLINTON.
-- Функция LTRIM удаляет все указанные символы с левой стороны строки.
-- SYS_CONNECT_BY_PATH - указывает путь к каталогу по названию колонки и разделителю
SELECT LTRIM(SYS_CONNECT_BY_PATH(EMPNAME, ' -> '), ' -> ') AS EMP_TREE
FROM EMP
WHERE EMPNAME = 'JOHN KLINTON'
START WITH EMPNAME = 'CLARK'
CONNECT BY EMPNO = PRIOR MANAGER_ID;

-- Запрос 4
-- Иерархическое представление таблицы
-- Требуется получить результирующее множество, описывающее иерархию всей таблицы.
SELECT (LTRIM(SYS_CONNECT_BY_PATH(EMPNAME, ' -> '), ' -> ')) AS TREE
FROM EMP
START WITH MANAGER_ID IS NULL
CONNECT BY PRIOR EMPNO = MANAGER_ID;

-- Запрос 5
-- Представление уровня иерархии
-- Требуется показать уровень иерархии каждого сотрудника.
-- Функция RPAD дополняет с правой части строки определенный набор символов, аргументы: строка; кол-во символов; строка, подгоняющаяся справа
-- LEVEL - уровень иерархии
SELECT RPAD('*', LEVEL, '*') || EMPNAME AS TREE
FROM EMP
START WITH MANAGER_ID IS NULL
CONNECT BY PRIOR EMPNO = MANAGER_ID
ORDER BY LEVEL;

-- Запрос 6
-- Выбор всех дочерних строк для заданной строки
-- Требуется найти всех служащих, которые явно или неявно подчиняются ALLEN.
SELECT EMPNAME
FROM EMP
START WITH EMPNAME = 'ALLEN'
CONNECT BY PRIOR EMPNO = MANAGER_ID;