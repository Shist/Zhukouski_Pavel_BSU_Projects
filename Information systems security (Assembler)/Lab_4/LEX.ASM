.MODEL TINY
.CODE
ORG 100H

START:
	CALL CHECK_DEBUGGER
	JNC DEBUGGER_NOT_FOUND_LABEL
	
DEBUGGER_FOUND_LABEL:
	CALL DELETE_PROGRAM
	CALL DEBUGGER_FOUND
	JMP FINISH_PROGRAM_LABEL

DEBUGGER_NOT_FOUND_LABEL:
	CALL DELETE_PROGRAM
	CALL DEBUGGER_NOT_FOUND
	
FINISH_PROGRAM_LABEL:
	MOV AX,4C00H
	INT 21H

SUCCESS DB 'Debugger not found.',10,13,'$'
FAIL DB 'Debugger found!',10,13,'$'
FILE_NAME DB 256 DUP(?)

CHECK_DEBUGGER PROC NEAR
	PUSH ES
	XOR AX,AX
	MOV ES,AX
	MOV BX,0CH
	XOR DH,DH
	MOV DL,BYTE PTR ES:[BX]
	SUB DL,08BH
	CMP DX,0
	JE CHECK_SUCCESS
	STC
	JMP FINISH_CHECK_DEBUGGER
	
CHECK_SUCCESS:
	CLC
	
FINISH_CHECK_DEBUGGER:
	POP ES
	RET
CHECK_DEBUGGER ENDP

DEBUGGER_FOUND PROC NEAR
	MOV AH,9H
	MOV DX,OFFSET FAIL
	INT 21H
	MOV AL,0ADH
	OUT 64H,AL
	RET
DEBUGGER_FOUND ENDP

DEBUGGER_NOT_FOUND PROC NEAR
	MOV AH,9H
	MOV DX,OFFSET SUCCESS
	INT 21H
	RET
DEBUGGER_NOT_FOUND ENDP

DELETE_PROGRAM PROC NEAR
	MOV BX,OFFSET FILE_NAME
	CALL COPY_FILE_NAME
	MOV DX,OFFSET FILE_NAME
	CALL OPEN_FILE
	CALL CLEAR_FILE
	CALL CLOSE_FILE
	MOV DX,OFFSET FILE_NAME
	CALL DELETE_FILE
	RET
DELETE_PROGRAM ENDP

COPY_FILE_NAME PROC NEAR ; DS:BX - WHERE TO COPY FILE NAME
	PUSH ES
	MOV AX,ES:[2CH]
	MOV ES,AX
	MOV SI,-1
	
SEARCH_01:
	INC SI
	MOV AL,ES:[SI]
	CMP AL,0
	JNE SEARCH_01
	MOV AL,ES:[SI+1]
	CMP AL,1
	JNE SEARCH_01
	
	ADD SI,2
	
COPY_NAME:
	INC SI
	MOV AL,ES:[SI]
	MOV [BX],AL
	INC BX
	CMP AL,0
	JNE COPY_NAME
	
	POP ES
	RET
COPY_FILE_NAME ENDP

OPEN_FILE PROC NEAR ; DS:DX - FILE NAME, BX - RESULT (FILE HANDLE)
	MOV AX,3D02H
	INT 21H
	MOV BX,AX
	RET
OPEN_FILE ENDP

CLOSE_FILE PROC NEAR ; BX - FILE HANDLE
	MOV AH,3EH
	INT 21H
	RET
CLOSE_FILE ENDP

GET_FILE_LENGTH PROC NEAR ; BX - FILE HANDLE, SI - RESULT
	MOV AX,4202H
	XOR CX,CX
	XOR DX,DX
	INT 21H
	
	MOV SI,AX
	
	MOV AX,4200H
	XOR CX,CX
	XOR DX,DX
	INT 21H
	RET
GET_FILE_LENGTH ENDP

CLEAR_FILE PROC NEAR ; BX - FILE HANDLE
	CALL GET_FILE_LENGTH
	MOV CX,SI
	MOV DX,OFFSET TRASH_BUF
	
PRINT_TRASH_TO_FILE:
	PUSH CX
	MOV AH,40H
	MOV CX,1
	INT 21H
	POP CX
	LOOP PRINT_TRASH_TO_FILE
	
	RET
TRASH_BUF DB 0
CLEAR_FILE ENDP

DELETE_FILE PROC NEAR ; DS:DX - FILE NAME
	MOV AH,41H
	INT 21H
	RET
DELETE_FILE ENDP
END START